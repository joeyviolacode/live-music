{% extends "base.html" %}
{% load i18n %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.3.0/main.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.3.0/main.js" defer></script>

<div class="musician-info-area flex justify-between">
    <div class="left pa4">
        <div class="left-top flex">
            <div class="picture">
                <div class="musician-show center">

                    <div class="pb3">
                    <img class="profile-photo br-100" src="{{ musician.full_cover.url }}">
                    </div>
                </div>
            </div>
            <div class="name-location pl4 w-50">
                <div class="flex">
                    <h1>
                        {{musician.name}}
                    </h1>
                    <p>
                        <a class="pl3 grow dib star" id="toggle-favorite" data-musician-id = "{{ musician.pk }}" class="no-underline pointer dib grow f3" id='parent-favorite'>
                            {% if user_favorite %}
                                &#9733;
                                {% else %}
                                &#9734;
                            {% endif %}
                        </a>
                    </p>
                   
                </div>
                <div class="flex flex-column justify-between h-75">
                    <div><p class="">{{musician.bio}}</p></div>
                    <div>
                        {% if musician.pk == user.pk %}
                            <div>
                                <a href="{% url 'add-donation' musician_pk=musician.pk %}">{% translate "Edit Donation Info" %}</a>
                            </div>
                            <div>
                                <a href="{% url 'edit-musician' musician_pk=musician.pk %}">{% translate "Edit profile" %}</a>
                            </div>  
                            <div>
                                <a href="{% url 'add-event' musician_pk=musician.pk %}">{% translate "Add an event" %}</a>
                            </div>     
                        {% else %}
                            {% if musician.cashapp_name %}
                                <p>Cashapp name: {{musician.cashapp_name}}</p>
                            {% endif %}
                            {% if musician.paypal_donation_url and not musician.paypal_qr %} 
                            <a href="{{musician.paypal_donation_url}}" target="_blank">Paypal link</a><br> 
                            {% endif %}

                            <div class="flex">

                            {% if musician.paypal_donation_url and not musician.paypal_qr %} 
                                <a href="{{musician.paypal_donation_url}}" target="_blank">Paypal link</a><br> 
                            {% endif %}


                            {% if musician.cashapp_qr %}
                                <div class="flex flex-column">
                                    <p class="qr-label">Cashapp:</p>
                                    <img class="qr" src="{{ musician.cashapp_qr.url }}"><br>
                                </div>
                            {% endif %}


                            {% if musician.paypal_donation_url and musician.paypal_qr %}
                            <div class="flex flex-column qr-box">
                                <p class="qr-label">Paypal:</p>
                                <a href="{{musician.paypal_donation_url}}"><img class="qr" src="{{ musician.paypal_qr.url }}" /></a><br>
                            </div>
                            {% endif %}


                            {% if musician.paypal_qr and not musician.paypal_donation_url %}
                            <div class="flex flex-column">
                                <p class="qr-label">Paypal:</p>
                                <img class="qr" src="{{ musician.paypal_qr.url }}"><br>
                            </div>
                            {% endif %}


                            {% if musician.venmo_qr %}
                            <div class="flex flex-column">
                                <p class="qr-label">Venmo:</p>
                                <img class="qr" src="{{ musician.venmo_qr.url }}">
                            </div>
                            {% endif %}
                            </div>
                        {% endif %}  
                    </div> 
                </div>     
            </div>
        </div>
    </div>

    <div class="right flex justify-around w-60 mt-3">
        <div id='calendar' class="w-70 pt2"></div>
    </div>

</div>



<div class="event-list">
    {%if musician.events.all.count %}
    <h3>{{musician.name}}'s {% translate "events:" %}</h3>
    {% endif %}
    <div class="flex flex-wrap">
        {% for event in musician.events.all %}
        {% if event.is_upcoming %}
        <a href="{% url 'event' pk=event.pk %}">
            <div class="shadow-3 br3 ma3 event-pane">
                    <div class="image-div flex pa2">
                        <img class="br2" src="{{ event.thumbnail.url }}">
                    </div>
                    <div class="info-div flex flex-column tc">
                        <h5 class="b">
                            {{event.title|truncatechars:20}}
                        </h5>
                        <p>
                            <a href="{% url 'show-musician' musician_pk=event.owner.user.pk %}">{{event.owner.name}}</a>
                        </p>
                        <p>
                            {{event.date_time}}
                        </p>
                        {% if user == musician.user %}
                        <a href="{% url 'edit-event' event_pk=event.pk %}">{% translate "Edit this event" %}</a>
                        {% endif %}
                    </div>
            </div>
        </a>
        {% endif %}
        {% endfor %}
    </div>
    {%if musician.events.all.count %}
    <h3>{% translate "Past events:" %}</h3>
    {% endif %}
    <div class="flex flex-wrap">
        {% for event in musician.events.all %}
        {% if event.is_finished %}
            <div class="shadow-3 br3 ma3 event-pane">
                <a href="{% url 'event' pk=event.pk %}">
                    <div class="image-div flex pa2">
                        <img class="br2" src="{{ event.thumbnail.url }}">
                    </div>
            </a>
                <div class="info-div flex flex-column tc">
                    <h5 class="b">
                        {{event.title|truncatechars:20}}
                    </h5>
                    <p>
                        <a href="{% url 'show-musician' musician_pk=event.owner.user.pk %}">{{event.owner.name}}</a>
                    </p>
                    <p>
                        {{event.date_time}}
                    </p>
                </div>
            </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Map -->
<div id='map' style='z-index: 7; width: 400px; height: 300px;'></div>


<!-- comments -->
{% if user.is_authenticated %}
<h6>{{ musician.musician_comments.count }} {% translate "comments" %}</h6>

{% for comment in musician.musician_comments.all %}

<div class="comments pl2 pt1">
    <p>{{ comment.message | linebreaks }}</p>
  <p class="pl2">
    by {{ comment.author }}, {{ comment.date_created }}
  </p>
</div>
{% endfor %}
{% endif %}

{% if user.is_authenticated %}
<form enctype="multipart/form-data" method="post" style="margin-top: 1.3em;">
    {% csrf_token %}
    {{ comment_form}}
  
  <button type="submit" class="btn btn-primary btn-sm">{% translate "Submit" %}</button>
</form>
{% endif %}



<script>
    window.addEventListener("load", (e) => {
        const toggleFavoriteLink = document.querySelector("#toggle-favorite")
        toggleFavoriteLink.addEventListener('click', function (e) {
            e.preventDefault()
            const musicianId = toggleFavoriteLink.dataset['musicianId']
            fetch(`/musician/${musicianId}/favorite`, {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                if (data.favorite) {
                    toggleFavoriteLink.innerHTML = '&#9733;'
                } else {
                    toggleFavoriteLink.innerHTML = '&#9734;'
                }
            })
        })
    }) 
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.3.0/main.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.3.0/main.js" defer></script>
<script>

//calendar starts here
    document.addEventListener('DOMContentLoaded', function() {
        const data = JSON.parse(_.unescape('{{events}}'))
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            eventSources: [
                {
                    events: data,
                    color: '157FE2',
                    display: 'block'
                }]
                
        });
        calendar.render();

//maps start here
        mapboxgl.accessToken = 'pk.eyJ1IjoicmthcnVuYXJhdG5lIiwiYSI6ImNrZWFib21lYTAzYnkyc283YnQxNXcwNncifQ.sAFQ90D6ZledgFX1gaoNxw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-83.0, 37.0],
            zoom: 10 
        });
    });

</script>

{% endblock content %}